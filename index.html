<!doctype html>
<html lang="kk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Қатысу — Сабаққа қатысу журналы</title>
    <link rel="manifest" href="/katysym/manifest.json" />
    <link rel="stylesheet" href="/katysym/style.css" />
  </head>
  <body data-lang="kk">
    <!-- Minimal container. Full UI is rendered by scripts in `app.js` or inline script. -->
    <div id="app">
      <main>
        <h1>Сабаққа қатысу</h1>
        <p>Осы бет — встраиваемая версия. Установите `WEBAPP_URL` в конфиге.</p>
      </main>
    </div>

    <script>
// ============================
// CONFIG
// ============================

// ✅ МЫНДА Worker/Proxy URL тұруы керек (мысалы: https://xxxx.workers.dev/?key=...)
// Егер проксиңыз query параметрлерді өткізіп тұрса — тек доменін қалдырыңыз.
const WEBAPP_URL =
  "PASTE_YOUR_WORKER_OR_SCRIPT_URL_HERE"; // <-- міндетті түрде ауыстырыңыз

const API_KEY = "school2025"; // Apps Script-тағы API_KEY-пен бірдей болсын

const STATUS = {
  katysty: { kk: "Қатысты", ru: "Присутствовал(а)" },
  keshikti: { kk: "Кешікті", ru: "Опоздал(а)" },
  auyrdy: { kk: "Ауырды", ru: "Болел(а)" },
  sebep: { kk: "Себепті", ru: "Отсутствовал(а) по уважительной причине" },
  sebsez: { kk: "Себепсіз", ru: "Отсутствовал(а) без уважительной причины" },
};

const I18N = {
  kk: {
    saveOk: "✅ Сақталды",
    saveErr: "❌ Қате:",
    loadErr: "Дерек жүктелмеді:",
    chooseClass: "Сынып таңдаңыз",
    noStudents: "Оқушылар табылмады",
  },
  ru: {
    saveOk: "✅ Сохранено",
    saveErr: "❌ Ошибка:",
    loadErr: "Не удалось загрузить данные:",
    chooseClass: "Выберите класс",
    noStudents: "Ученики не найдены",
  },
};

// ============================
// STATE
// ============================
let currentLang = document.body?.dataset?.lang || "kk";
let studentsCache = []; // ағымдағы сынып оқушылары
let selectedClass = "ALL";

// ============================
// HELPERS
// ============================
function $(id) {
  return document.getElementById(id);
}

function showView(id) {
  document.querySelectorAll(".view").forEach((v) => v.classList.remove("active"));
  $(id)?.classList.add("active");
}

function setLang(lang) {
  currentLang = lang;
  document.body.dataset.lang = lang;
}

function normalizeClassValue(v) {
  return String(v ?? "").replace(/\s+/g, "").toUpperCase();
}

function splitClass(cls) {
  const s = normalizeClassValue(cls);
  if (!s || s === "ALL") return { grade: "ALL", class_letter: "ALL" };
  const grade = s.match(/^\d+/)?.[0] ?? "";
  const class_letter = s.slice(grade.length) || "";
  return { grade, class_letter };
}

async function apiGet(params) {
  const url = new URL(WEBAPP_URL);
  if (!url.searchParams.get("key")) url.searchParams.set("key", API_KEY);
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && v !== "") url.searchParams.set(k, String(v));
  });
  const resp = await fetch(url.toString(), { method: "GET" });
  const text = await resp.text();
  let json;
  try { json = JSON.parse(text); } catch {
    throw new Error("API JSON емес жауап берді: " + text.slice(0, 120));
  }
  if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${text.slice(0, 120)}`);
  if (json && json.ok === false) throw new Error(json.error || "API error");
  return json;
}

async function apiPost(body) {
  const url = new URL(WEBAPP_URL);
  if (!url.searchParams.get("key")) url.searchParams.set("key", API_KEY);
  const resp = await fetch(url.toString(), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });
  const text = await resp.text();
  let json;
  try { json = JSON.parse(text); } catch {
    throw new Error("API JSON емес жауап берді: " + text.slice(0, 120));
  }
  if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${text.slice(0, 120)}`);
  if (json && json.ok === false) throw new Error(json.error || "API error");
  return json;
}

// minimal init placeholder; full app lives in `app.js`
document.addEventListener("DOMContentLoaded", () => {
  // If developer prefers the standalone inline script, the rest of UI functions can be placed here.
  // Otherwise the project uses `app.js` as the main implementation — include it instead.
});
    </script>

    <!-- Prefer including `app.js` for the full-featured UI. -->
    <script src="/katysym/app.js"></script>
  </body>
</html>
// ============================
// DATA LOAD
// ============================
async function loadClassesToSelects() {
  const classSelect = $("classSelect");
  const reportClass = $("reportClass");

  const putOptions = (sel) => {
    if (!sel) return;
    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "ALL";
    sel.appendChild(optAll);
  };

  putOptions(classSelect);
  putOptions(reportClass);

  const data = await apiGet({ mode: "classes" });
  const classes = data?.classes || [];

  classes.forEach((cls) => {
    const o1 = document.createElement("option");
    o1.value = cls;
    o1.textContent = cls;
    classSelect?.appendChild(o1);

    const o2 = document.createElement("option");
    o2.value = cls;
    o2.textContent = cls;
    reportClass?.appendChild(o2);
  });
}

async function loadStudentsForSelectedClass() {
  const cls = $("classSelect")?.value || "ALL";
  selectedClass = cls;

  if (cls === "ALL") {
    studentsCache = [];
    renderAttendanceTable([]);
    return;
  }

  const { grade, class_letter } = splitClass(cls);
  const data = await apiGet({ mode: "students", grade, class_letter });
  studentsCache = data?.students || [];
  renderAttendanceTable(studentsCache);
}

async function saveAttendance() {
  const date = $("attendanceDate")?.value;
  const cls = $("classSelect")?.value;

  const statusBox = $("saveStatus");
  if (statusBox) statusBox.textContent = "";

  if (!date || !cls || cls === "ALL") {
    if (statusBox) statusBox.textContent = I18N[currentLang].chooseClass;
    return;
  }

  const { grade, class_letter } = splitClass(cls);

  // барлық select мәндерін жинаймыз
  const records = Array.from(document.querySelectorAll(".statusSelect")).map((sel) => ({
    student_id: sel.dataset.sid,
    status_code: sel.value || "katysty",
  }));

  // ✅ Егер “Қатысты” да көп болса — бәрін жібереміз (кейін backend-та “қайта басуды” тежейміз)
  const body = {
    key: API_KEY,
    date,
    grade,
    class_letter,
    records,
  };

  const btn = $("saveAttendanceBtn");
  if (btn) btn.disabled = true;

  try {
    await apiPost(body);
    if (statusBox) statusBox.textContent = I18N[currentLang].saveOk;
  } catch (e) {
    if (statusBox) statusBox.textContent = `${I18N[currentLang].saveErr} ${e.message}`;
  } finally {
    if (btn) btn.disabled = false;
  }
}

// ============================
// INIT
// ============================
document.addEventListener("DOMContentLoaded", async () => {
  // Навигация
  $("goAttendance")?.addEventListener("click", () => showView("viewAttendance"));
  $("goReports")?.addEventListener("click", () => showView("viewReports"));
  $("backHome1")?.addEventListener("click", () => showView("viewHome"));
  $("backHome2")?.addEventListener("click", () => showView("viewHome"));

  // Тіл ауыстыру
  $("langToggle")?.addEventListener("click", () => {
    setLang(currentLang === "kk" ? "ru" : "kk");
  });

  // Date default
  const todayISO = new Date().toISOString().slice(0, 10);
  if ($("attendanceDate")) $("attendanceDate").value = todayISO;

  // Search
  $("searchInput")?.addEventListener("input", applySearchFilter);

  // Save
  $("saveAttendanceBtn")?.addEventListener("click", saveAttendance);

  // Load initial
  try {
    await loadClassesToSelects();
    $("classSelect")?.addEventListener("change", loadStudentsForSelectedClass);
  } catch (e) {
    const box = $("saveStatus");
    if (box) box.textContent = `${I18N[currentLang].loadErr} ${e.message}`;
  }
});
